@inject IToolService ToolService
@inject IToolCategoryService ToolCategoryService
@inject ISnackbar Snackbar
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@using ToolNexus.Application.Tools.DTOs
@using ToolNexus.Application.ToolCategories
@using ToolNexus.Application.ToolCategories.DTOs
@using ToolNexus.WebUI.Server.Components.Shared
@using System.ComponentModel.DataAnnotations

@if (IsVisible)
{
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; overflow-y: auto; padding: 20px 10px;">
        <MudPaper Class="pa-6" Style="max-width: 600px; width: 90vw; margin: 20px auto;" Elevation="8">
            <EditForm EditContext="editContext" OnValidSubmit="HandleValidSubmit">
                <DataAnnotationsValidator />
                <MudStack Spacing="3">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.h5">Hitro upravljanje zaloge</MudText>
                        <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="HandleCancel" />
                    </MudStack>

                    @if (isLoadingData)
                    {
                        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
                        <MudText Align="Align.Center" Typo="Typo.body2">Nalagam podatke...</MudText>
                    }
                    else
                    {
                        <MudExpansionPanels Elevation="1" Class="mb-3">
                            <MudExpansionPanel Text="Skeniranje QR kode" Icon="@Icons.Material.Filled.QrCodeScanner">
                                <QRCodeScanner OnCodeScanned="HandleScannedCode" />
                                @if (!string.IsNullOrEmpty(scannedCode))
                                {
                                    <MudAlert Severity="Severity.Info" Class="mt-2">
                                        Skenirana koda: @scannedCode
                                    </MudAlert>
                                }
                            </MudExpansionPanel>
                        </MudExpansionPanels>
                        
                        <MudSelect T="int?" @bind-Value="categoryFilter" 
                                   Label="Filter po kategoriji" 
                                   Clearable="true"
                                   @bind-Value:after="FilterToolsByCategory"
                                   Variant="Variant.Outlined"
                                   Dense="true">
                            @if (categories != null)
                            {
                                @foreach (var category in categories)
                                {
                                    <MudSelectItem Value="@((int?)category.Id)">@category.Name</MudSelectItem>
                                }
                            }
                        </MudSelect>

                        <MudAutocomplete T="ToolDto" 
                                         @bind-Value="selectedTool"
                                         Label="Izberi orodje"
                                         SearchFunc="@SearchTools"
                                         ToStringFunc="@(tool => tool == null ? null : $"{tool.Name} ({tool.Code})")"
                                         Dense="true"
                                         Variant="Variant.Outlined"
                                         ResetValueOnEmptyText="true"
                                         ShowProgressIndicator="true"
                                         Required="true"
                                         @bind-Value:after="OnToolSelected">
                            <ItemTemplate Context="tool">
                                <MudStack Spacing="0">
                                    <MudText>@tool.Name (@tool.Code)</MudText>
                                    <MudText Typo="Typo.caption">Trenutna zaloga: @tool.CurrentStock</MudText>
                                </MudStack>
                            </ItemTemplate>
                        </MudAutocomplete>
                    }

                    @if (selectedTool != null)
                    {
                        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                            <MudStack>
                                <MudText><strong>Orodje:</strong> @selectedTool.Name (@selectedTool.Code)</MudText>
                                <MudText><strong>Trenutna zaloga:</strong> @selectedTool.CurrentStock</MudText>
                                <MudText><strong>Minimalna zaloga:</strong> @selectedTool.MinimumStock | <strong>Kritična zaloga:</strong> @selectedTool.CriticalStock</MudText>
                            </MudStack>
                        </MudAlert>

                        <MudRadioGroup @bind-Value="adjustmentModel.AdjustmentType">
                            <MudRadio Value="StockAdjustmentType.Increase" Color="Color.Success" Disabled="@(!canIncrease)">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudIcon Icon="@Icons.Material.Filled.Add" Size="Size.Small" />
                                    <MudText>Povečaj zalogo</MudText>
                                    @if (!canIncrease)
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Error">(Ni dovoljenja)</MudText>
                                    }
                                </MudStack>
                            </MudRadio>
                            <MudRadio Value="StockAdjustmentType.Decrease" Color="Color.Error">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudIcon Icon="@Icons.Material.Filled.Remove" Size="Size.Small" />
                                    <MudText>Zmanjšaj zalogo</MudText>
                                </MudStack>
                            </MudRadio>
                        </MudRadioGroup>

                        <MudNumericField @bind-Value="adjustmentModel.Quantity"
                                         For="@(() => adjustmentModel.Quantity)"
                                         Label="Količina"
                                         Variant="Variant.Outlined"
                                         Min="1"
                                         Required="true"
                                         HelperText="@GetQuantityHelperText()" />

                        @if (adjustmentModel.AdjustmentType == StockAdjustmentType.Decrease)
                        {
                            <MudSelect @bind-Value="adjustmentModel.Reason"
                                       For="@(() => adjustmentModel.Reason)"
                                       Label="Razlog zmanjšanja"
                                       Variant="Variant.Outlined"
                                       Required="true">
                                <MudSelectItem Value="@("Poškodovano")">Poškodovano</MudSelectItem>
                                <MudSelectItem Value="@("Izgubljeno")">Izgubljeno</MudSelectItem>
                                <MudSelectItem Value="@("Odpisano")">Odpisano</MudSelectItem>
                                <MudSelectItem Value="@("Drugo")">Drugo</MudSelectItem>
                            </MudSelect>
                        }

                        <MudTextField @bind-Value="adjustmentModel.Notes"
                                      For="@(() => adjustmentModel.Notes)"
                                      Label="Opombe"
                                      Variant="Variant.Outlined"
                                      Lines="3" />

                        <MudAlert Severity="@(GetPreviewSeverity())" Variant="Variant.Outlined">
                            <MudText>@GetPreviewMessage()</MudText>
                        </MudAlert>

                        <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2">
                            <MudButton Variant="Variant.Outlined" OnClick="HandleCancel">
                                Prekliči
                            </MudButton>
                            <MudButton ButtonType="ButtonType.Submit"
                                       Variant="Variant.Filled"
                                       Color="@(adjustmentModel.AdjustmentType == StockAdjustmentType.Increase ? Color.Success : Color.Error)"
                                       Disabled="@(isSubmitting)">
                                @if (isSubmitting)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                }
                                else
                                {
                                    @(adjustmentModel.AdjustmentType == StockAdjustmentType.Increase ? "Povečaj" : "Zmanjšaj")
                                }
                            </MudButton>
                        </MudStack>
                    }
                </MudStack>
            </EditForm>
        </MudPaper>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> OnResult { get; set; }

    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; } = default!;

    private EditContext editContext = default!;
    private StockAdjustmentModel adjustmentModel = new();
    private bool isSubmitting = false;
    private bool canIncrease = false;
    private bool isLoadingData = false;
    
    private List<ToolDto>? tools;
    private List<ToolDto>? filteredTools;
    private List<ToolCategoryDto>? categories;
    private int? categoryFilter;
    private ToolDto? selectedTool;
    private string? scannedCode;

    protected override async Task OnInitializedAsync()
    {
        // Check user roles
        var authState = await authenticationStateTask;
        if (authState.User.Identity.IsAuthenticated)
        {
            var userRoles = authState.User.Claims
                .Where(c => c.Type == ClaimTypes.Role)
                .Select(c => c.Value)
                .ToList();
            
            canIncrease = userRoles.Contains("ADMIN") || userRoles.Contains("SUPERVISOR");
        }
        
        editContext = new EditContext(adjustmentModel);
    }

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible)
        {
            // Load data when dialog opens
            if (tools == null || categories == null)
            {
                await LoadData();
            }
            
            // Reset form when dialog opens
            categoryFilter = null;
            selectedTool = null;
            scannedCode = null;
            adjustmentModel = new StockAdjustmentModel
            {
                AdjustmentType = canIncrease ? StockAdjustmentType.Increase : StockAdjustmentType.Decrease,
                Quantity = 1
            };
            filteredTools = tools;
            editContext = new EditContext(adjustmentModel);
            StateHasChanged();
        }
    }

    private async Task LoadData()
    {
        try
        {
            isLoadingData = true;
            StateHasChanged();
            
            // Load categories and tools separately to avoid DbContext conflicts
            categories = await ToolCategoryService.GetActiveAsync();
            tools = await ToolService.GetActiveToolsAsync();
            filteredTools = tools;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Napaka pri nalaganju podatkov: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoadingData = false;
            StateHasChanged();
        }
    }

    private void FilterToolsByCategory()
    {
        if (categoryFilter.HasValue && tools != null)
        {
            filteredTools = tools.Where(t => t.ToolCategoryId == categoryFilter.Value).ToList();
        }
        else
        {
            filteredTools = tools;
        }
        selectedTool = null;
        StateHasChanged();
    }

    private async Task<IEnumerable<ToolDto>> SearchTools(string value, CancellationToken cancellationToken = default)
    {
        await Task.Delay(5, cancellationToken); // Small delay for better UX
        
        var toolsToSearch = filteredTools ?? tools ?? new List<ToolDto>();
        
        if (string.IsNullOrEmpty(value))
            return toolsToSearch.Take(10);
            
        return toolsToSearch.Where(t => 
            t.Name.Contains(value, StringComparison.OrdinalIgnoreCase) ||
            t.Code.Contains(value, StringComparison.OrdinalIgnoreCase))
            .Take(10);
    }

    private void OnToolSelected()
    {
        if (selectedTool != null)
        {
            adjustmentModel.ToolId = selectedTool.Id;
            StateHasChanged();
        }
    }

    private async Task HandleValidSubmit()
    {
        if (selectedTool == null) return;

        // Custom validation for decrease
        if (adjustmentModel.AdjustmentType == StockAdjustmentType.Decrease && string.IsNullOrWhiteSpace(adjustmentModel.Reason))
        {
            Snackbar.Add("Pri zmanjšanju zaloge je razlog obvezen!", Severity.Error);
            return;
        }

        try
        {
            isSubmitting = true;
            StateHasChanged();

            var authState = await authenticationStateTask;
            var userId = authState.User.Identity?.Name ?? "system";

            if (adjustmentModel.AdjustmentType == StockAdjustmentType.Increase)
            {
                await ToolService.IncreaseStockAsync(new IncreaseStockDto
                {
                    ToolId = selectedTool.Id,
                    Quantity = adjustmentModel.Quantity,
                    Notes = adjustmentModel.Notes,
                    UserId = userId
                });
                Snackbar.Add($"Zaloga orodja {selectedTool.Name} je bila uspešno povečana za {adjustmentModel.Quantity}.", Severity.Success);
            }
            else
            {
                await ToolService.DecreaseStockAsync(new DecreaseStockDto
                {
                    ToolId = selectedTool.Id,
                    Quantity = adjustmentModel.Quantity,
                    Reason = adjustmentModel.Reason!,
                    Notes = adjustmentModel.Notes,
                    UserId = userId
                });
                Snackbar.Add($"Zaloga orodja {selectedTool.Name} je bila uspešno zmanjšana za {adjustmentModel.Quantity}.", Severity.Success);
            }

            await OnResult.InvokeAsync(true);
        }
        catch (InvalidOperationException ex)
        {
            Snackbar.Add($"Napaka: {ex.Message}", Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Napaka pri spreminjanju zaloge: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private Task HandleCancel()
    {
        return OnResult.InvokeAsync(false);
    }

    private string GetQuantityHelperText()
    {
        if (selectedTool == null) return "";
        
        if (adjustmentModel.AdjustmentType == StockAdjustmentType.Decrease)
        {
            return $"Maksimalno: {selectedTool.CurrentStock}";
        }
        return "Vnesite količino za povečanje zaloge";
    }

    private Severity GetPreviewSeverity()
    {
        if (selectedTool == null) return Severity.Info;

        var newStock = adjustmentModel.AdjustmentType == StockAdjustmentType.Increase
            ? selectedTool.CurrentStock + adjustmentModel.Quantity
            : selectedTool.CurrentStock - adjustmentModel.Quantity;

        if (newStock <= selectedTool.CriticalStock)
            return Severity.Error;
        if (newStock <= selectedTool.MinimumStock)
            return Severity.Warning;
        
        return Severity.Success;
    }

    private string GetPreviewMessage()
    {
        if (selectedTool == null) return "";

        var newStock = adjustmentModel.AdjustmentType == StockAdjustmentType.Increase
            ? selectedTool.CurrentStock + adjustmentModel.Quantity
            : selectedTool.CurrentStock - adjustmentModel.Quantity;

        if (newStock < 0)
            return "⚠️ Zaloga ne more biti negativna!";

        var stockStatus = newStock <= selectedTool.CriticalStock ? " (KRITIČNO!)" 
            : newStock <= selectedTool.MinimumStock ? " (pod minimalno zalogo)" 
            : "";

        return $"Nova zaloga bo: {newStock}{stockStatus}";
    }
    
    private async Task HandleScannedCode(string code)
    {
        scannedCode = code;
        
        // Poišči orodje po kodi
        if (tools != null && !string.IsNullOrEmpty(code))
        {
            var tool = tools.FirstOrDefault(t => t.Code.Equals(code, StringComparison.OrdinalIgnoreCase));
            if (tool != null)
            {
                // Če ima orodje kategorijo, nastavi filter
                if (tool.ToolCategoryId.HasValue)
                {
                    categoryFilter = tool.ToolCategoryId.Value;
                    FilterToolsByCategory();
                }
                
                selectedTool = tool;
                OnToolSelected();
                
                Snackbar.Add($"Najdeno orodje: {tool.Name}", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Orodje s kodo '{code}' ni bilo najdeno.", Severity.Warning);
            }
        }
        
        StateHasChanged();
    }

    public enum StockAdjustmentType
    {
        Increase,
        Decrease
    }

    public class StockAdjustmentModel
    {
        public int ToolId { get; set; }

        public StockAdjustmentType AdjustmentType { get; set; } = StockAdjustmentType.Increase;

        [Required(ErrorMessage = "Količina je obvezna")]
        [Range(1, int.MaxValue, ErrorMessage = "Količina mora biti vsaj 1")]
        public int Quantity { get; set; } = 1;

        public string? Reason { get; set; }

        public string? Notes { get; set; }
    }
}