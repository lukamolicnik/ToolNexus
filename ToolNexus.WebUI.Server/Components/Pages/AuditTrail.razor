@page "/audit-trail"
@using Microsoft.AspNetCore.Authorization
@using ToolNexus.Application.Audit
@using ToolNexus.Application.Audit.DTOs
@using MudBlazor
@using ToolNexus.WebUI.Server.Components.Dialogs
@inject IAuditService AuditService
@inject ISnackbar Snackbar
@attribute [Authorize(Roles = "ADMIN")]
@rendermode InteractiveServer

<PageTitle>Revizijska Sled</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Revizijska Sled</MudText>
    
    <MudPaper Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" sm="4">
                <MudSelect @bind-Value="selectedEntityType" Label="Tip Entitete" Clearable="true">
                    <MudSelectItem Value='"User"'>Uporabniki</MudSelectItem>
                    <MudSelectItem Value='"Tool"'>Orodja</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="4">
                <MudSelect @bind-Value="selectedAction" Label="Akcija" Clearable="true">
                    <MudSelectItem Value='"Create"'>Ustvarjeno</MudSelectItem>
                    <MudSelectItem Value='"Update"'>Posodobljeno</MudSelectItem>
                    <MudSelectItem Value='"Delete"'>Izbrisano</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="4">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadAuditTrails" StartIcon="@Icons.Material.Filled.Search">
                    Iskanje
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (loading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else if (auditTrails != null && auditTrails.Any())
    {
        <MudTable Items="@auditTrails" Hover="true" Striped="true" Dense="true">
            <HeaderContent>
                <MudTh>Datum in čas</MudTh>
                <MudTh>Uporabnik</MudTh>
                <MudTh>Entiteta</MudTh>
                <MudTh>ID</MudTh>
                <MudTh>Akcija</MudTh>
                <MudTh>Tabela</MudTh>
                <MudTh>Akcije</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Datum in čas">@context.Timestamp.ToString("dd.MM.yyyy HH:mm:ss")</MudTd>
                <MudTd DataLabel="Uporabnik">@context.UserName</MudTd>
                <MudTd DataLabel="Entiteta">@context.EntityType</MudTd>
                <MudTd DataLabel="ID">@GetEntityIdDisplay(context.EntityId)</MudTd>
                <MudTd DataLabel="Akcija">
                    <MudChip T="string" Size="Size.Small" Color="@GetActionColor(context.Action)">
                        @GetActionDisplay(context.Action)
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Tabela">@context.TableName</MudTd>
                <MudTd DataLabel="Akcije">
                    <MudTooltip Text="Prikaži podrobnosti">
                        <MudIconButton Icon="@Icons.Material.Filled.Info" Color="Color.Primary" Size="Size.Small" 
                                       OnClick="@(() => ShowDetailsDialog(context))" />
                    </MudTooltip>
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
    else
    {
        <MudAlert Severity="Severity.Info">Ni najdenih zapisov revizijske sledi.</MudAlert>
    }
</MudContainer>

<AuditDetailsDialog IsVisible="@showDetailsDialog"
                   AuditTrail="@selectedAudit"
                   OnResult="@(() => showDetailsDialog = false)" />

@code {
    private List<AuditTrailDto>? auditTrails;
    private bool loading = false;
    private string selectedEntityType = "";
    private string selectedAction = "";
    private bool showDetailsDialog = false;
    private AuditTrailDto? selectedAudit;

    protected override async Task OnInitializedAsync()
    {
        await LoadAuditTrails();
    }

    private async Task LoadAuditTrails()
    {
        try
        {
            loading = true;
            
            var filter = new AuditTrailFilterDto
            {
                EntityType = string.IsNullOrEmpty(selectedEntityType) ? null : selectedEntityType,
                Action = string.IsNullOrEmpty(selectedAction) ? null : selectedAction,
                PageSize = 100
            };
            
            auditTrails = (await AuditService.GetByFilterAsync(filter)).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Napaka pri nalaganju: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private void ShowDetailsDialog(AuditTrailDto audit)
    {
        selectedAudit = audit;
        showDetailsDialog = true;
    }

    private string GetEntityIdDisplay(string entityId)
    {
        try
        {
            // Try to parse as JSON and extract ID
            if (entityId.StartsWith("{") && entityId.EndsWith("}"))
            {
                var idValue = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, object>>(entityId);
                return idValue?.FirstOrDefault().Value?.ToString() ?? entityId;
            }
        }
        catch { }
        
        return entityId;
    }

    private Color GetActionColor(string action)
    {
        return action switch
        {
            "Create" => Color.Success,
            "Update" => Color.Info,
            "Delete" => Color.Error,
            _ => Color.Default
        };
    }

    private string GetActionDisplay(string action)
    {
        return action switch
        {
            "Create" => "Ustvarjeno",
            "Update" => "Posodobljeno",
            "Delete" => "Izbrisano",
            _ => action
        };
    }
}