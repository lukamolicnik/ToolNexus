@page "/reports/loss-cost-by-category"
@using Microsoft.AspNetCore.Authorization
@using ToolNexus.Application.Reports
@using ToolNexus.Application.Reports.DTOs
@using MudBlazor
@inject IReportService ReportService
@inject ISnackbar Snackbar
@attribute [Authorize(Roles = "ADMIN,SUPERVISOR")]
@rendermode InteractiveServer

<PageTitle>Stroški Izgub po Kategorijah</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="pa-2 pa-sm-3 pa-md-4">
    <MudStack Spacing="4">
        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudText Typo="Typo.h4">Stroški Izgub po Kategorijah</MudText>
            </MudItem>
            <MudItem xs="12" sm="6" Class="d-flex justify-end">
                <MudButton Variant="Variant.Outlined" 
                          StartIcon="@Icons.Material.Filled.ArrowBack" 
                          Href="/">
                    Nazaj
                </MudButton>
            </MudItem>
        </MudGrid>

        <MudPaper Class="pa-4">
            <MudGrid>
                <MudItem xs="12" sm="6" md="3">
                    <MudDatePicker @bind-Date="startDate" 
                                  Label="Od datuma" 
                                  Required="true"
                                  MaxDate="DateTime.Today"
                                  Variant="Variant.Outlined"
                                  Dense="true" />
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudDatePicker @bind-Date="endDate" 
                                  Label="Do datuma" 
                                  Required="true"
                                  MaxDate="DateTime.Today"
                                  Variant="Variant.Outlined"
                                  Dense="true" />
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudNumericField @bind-Value="minimumLossValue" 
                                    Label="Minimalna vrednost izgube (€)" 
                                    Min="0"
                                    Step="100"
                                    Variant="Variant.Outlined"
                                    Dense="true" />
                </MudItem>
                <MudItem xs="12" sm="6" md="3" Class="d-flex align-center">
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              StartIcon="@Icons.Material.Filled.Search"
                              OnClick="LoadReport"
                              Disabled="isLoading"
                              FullWidth="true"
                              Class="mt-2">
                        @if (isLoading)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                            <span>Nalagam...</span>
                        }
                        else
                        {
                            <span>Prikaži Poročilo</span>
                        }
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>

        @if (report != null)
        {
            <MudPaper Class="pa-4">
                <MudStack Spacing="3">
                    <MudText Typo="Typo.h5">
                        Povzetek od @report.StartDate.ToString("dd.MM.yyyy") do @report.EndDate.ToString("dd.MM.yyyy")
                    </MudText>
                    
                    <MudGrid>
                        <MudItem xs="12" sm="6" md="3">
                            <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="w-100 h-100">
                                <MudStack Spacing="0" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.h6">@report.Summary.TotalEstimatedValue.ToString("C2")</MudText>
                                    <MudText Typo="Typo.body2">Skupna Vrednost Izgub</MudText>
                                </MudStack>
                            </MudAlert>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Class="w-100 h-100">
                                <MudStack Spacing="0" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.h6">@report.Summary.TotalQuantityLost</MudText>
                                    <MudText Typo="Typo.body2">Skupna Količina</MudText>
                                </MudStack>
                            </MudAlert>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Class="w-100 h-100">
                                <MudStack Spacing="0" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.h6">@report.Summary.TotalCategories</MudText>
                                    <MudText Typo="Typo.body2">Prizadetih Kategorij</MudText>
                                </MudStack>
                            </MudAlert>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudAlert Severity="Severity.Success" Variant="Variant.Filled" Class="w-100 h-100">
                                <MudStack Spacing="0" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.h6">@report.Summary.TotalToolsAffected</MudText>
                                    <MudText Typo="Typo.body2">Prizadetih Orodij</MudText>
                                </MudStack>
                            </MudAlert>
                        </MudItem>
                    </MudGrid>

                    @if (report.Summary.MostAffectedCategory != null)
                    {
                        <MudAlert Severity="Severity.Warning">
                            <MudText>
                                <strong>Najbolj prizadeta kategorija:</strong> @report.Summary.MostAffectedCategory.CategoryName 
                                (@report.Summary.MostAffectedCategory.EstimatedValue.ToString("C2"))
                            </MudText>
                        </MudAlert>
                    }
                </MudStack>
            </MudPaper>

            <MudPaper Class="pa-4">
                <MudStack Spacing="3">
                    <MudText Typo="Typo.h6">Stroški po Kategorijah</MudText>
                    
                    @foreach (var category in report.Categories)
                    {
                        <MudExpansionPanels Elevation="2" Rounded="true">
                            <MudExpansionPanel>
                                <TitleContent>
                                    <div class="pa-2" style="width: 100%;">
                                        <MudGrid AlignItems="AlignItems.Center">
                                            <MudItem xs="12" sm="8">
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="flex-wrap">
                                                    <MudText Typo="Typo.subtitle1">
                                                        <strong>@category.CategoryName</strong>
                                                    </MudText>
                                                    <MudChip T="string" Color="Color.Error" Size="Size.Small">
                                                        @category.EstimatedValue.ToString("C2")
                                                    </MudChip>
                                                    <MudChip T="string" Color="Color.Warning" Size="Size.Small">
                                                        @category.TotalQuantity kom
                                                    </MudChip>
                                                    <MudChip T="string" Color="Color.Info" Size="Size.Small">
                                                        @category.PercentageOfTotalLoss.ToString("F1")%
                                                    </MudChip>
                                                </MudStack>
                                            </MudItem>
                                            <MudItem xs="12" sm="4">
                                                <MudProgressLinear Value="(double)category.PercentageOfTotalLoss" 
                                                                  Color="Color.Error" 
                                                                  Size="Size.Medium" />
                                            </MudItem>
                                        </MudGrid>
                                    </div>
                                </TitleContent>
                                <ChildContent>
                                    @if (category.Tools.Any())
                                    {
                                        <MudDataGrid T="CategoryToolLossDto" Items="category.Tools" Dense="true" Hover="true">
                                            <Columns>
                                                <PropertyColumn Property="x => x.ToolCode" Title="Koda" />
                                                <PropertyColumn Property="x => x.ToolName" Title="Naziv" />
                                                <PropertyColumn Property="x => x.LostQuantity" Title="Izgubljeno" />
                                                <PropertyColumn Property="x => x.DamagedQuantity" Title="Poškodovano" />
                                                <PropertyColumn Property="x => x.DiscardedQuantity" Title="Odpisano" />
                                                <PropertyColumn Property="x => x.TotalQuantity" Title="Skupaj" />
                                                <TemplateColumn Title="Ocenjena Vrednost">
                                                    <CellTemplate>
                                                        <MudText>@context.Item.EstimatedValue.ToString("C2")</MudText>
                                                    </CellTemplate>
                                                </TemplateColumn>
                                            </Columns>
                                        </MudDataGrid>
                                    }
                                    else
                                    {
                                        <MudAlert Severity="Severity.Info">
                                            V tej kategoriji ni bilo izgub v izbranem obdobju.
                                        </MudAlert>
                                    }
                                </ChildContent>
                            </MudExpansionPanel>
                        </MudExpansionPanels>
                    }
                </MudStack>
            </MudPaper>
        }
    </MudStack>
</MudContainer>

@code {
    private DateTime? startDate = DateTime.Today.AddMonths(-1);
    private DateTime? endDate = DateTime.Today;
    private int? minimumLossValue = null;
    private LossCostByCategoryReportDto? report;
    private bool isLoading = false;

    private async Task LoadReport()
    {
        if (startDate == null || endDate == null)
        {
            Snackbar.Add("Prosimo, izberite veljavno časovno obdobje.", Severity.Warning);
            return;
        }

        if (startDate > endDate)
        {
            Snackbar.Add("Začetni datum ne sme biti večji od končnega datuma.", Severity.Warning);
            return;
        }

        try
        {
            isLoading = true;
            StateHasChanged();

            var request = new LossCostByCategoryReportRequestDto
            {
                StartDate = startDate.Value,
                EndDate = endDate.Value.Date.AddDays(1).AddSeconds(-1), // Do konca dneva
                IncludeToolDetails = true, // Vedno prikaži podrobnosti
                MinimumLossValue = minimumLossValue
            };

            report = await ReportService.GetLossCostByCategoryReportAsync(request);
            
            if (report.Categories.Count == 0)
            {
                Snackbar.Add("V izbranem obdobju ni bilo zabeleženih izgub.", Severity.Info);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Napaka pri generiranju poročila: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}